# Maintainer: Maurizio D'Addona <mauritiusdadd@gmail.com>

pkgname="bcwc_pcie"
pkgver=r199.7317a76
pkgrel=1
pkgdesc="Reverse engineered Linux driver for the Broadcom 1570 PCIe webcam"
url="https://github.com/patjak/bcwc_pcie"
depends=('kmod' 'bcwc_pcie-firmware')
optdepends=()
makedepends=('linux>=4.3' 'linux<4.4' 'linux-headers' 'git')
arch=('i686' 'x86_64')
license=('custom')
install="${pkgname}.install"

_extramodules="extramodules-4.3-ARCH"

source=("${pkgname}::git+https://github.com/patjak/bcwc_pcie.git#commit=7317a7677103655e530f614c0845c287beded723")

sha256sums=('SKIP')

pkgver()
{
  cd "${srcdir}/${pkgname}"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

build()
{
  cd "${srcdir}/${pkgname}"
  make ${MAKEFLAGS}

  gzip -9 "facetimehd.ko"
}

package()
{
  cd "${srcdir}/${pkgname}"

  install -dm755 "$pkgdir/usr/lib/modules/$_extramodules/"
  install -m644 'facetimehd.ko.gz' "$pkgdir/usr/lib/modules/$_extramodules/"
}
